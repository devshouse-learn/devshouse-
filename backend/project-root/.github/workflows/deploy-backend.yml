name: Deploy Backend to Elastic Beanstalk

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create deployment package (Linux-compatible)
        working-directory: ./backend
        run: |
          # Crear ZIP con formato compatible Linux (forward slashes)
          zip -r deploy-package.zip \
            src/ \
            .ebextensions/ \
            .platform/ \
            package.json \
            package-lock.json \
            Procfile \
            .ebignore \
            -x "*.git*" "node_modules/*" "*.env*"
          
          echo "üì¶ Package created: $(du -h deploy-package.zip | cut -f1)"

      - name: Get timestamp
        id: timestamp
        run: echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Upload package to S3
        working-directory: ./backend
        run: |
          VERSION_LABEL="auto-deploy-${{ steps.timestamp.outputs.timestamp }}"
          S3_KEY="deploys/${VERSION_LABEL}.zip"
          
          echo "üì§ Uploading to S3..."
          aws s3 cp deploy-package.zip "s3://${{ secrets.S3_BUCKET_NAME }}/${S3_KEY}"
          
          echo "version_label=${VERSION_LABEL}" >> $GITHUB_OUTPUT
          echo "s3_key=${S3_KEY}" >> $GITHUB_OUTPUT
        id: upload

      - name: Create Elastic Beanstalk version
        run: |
          echo "üîß Creating EB application version..."
          aws elasticbeanstalk create-application-version \
            --application-name devshouse-backend \
            --version-label "${{ steps.upload.outputs.version_label }}" \
            --source-bundle S3Bucket="${{ secrets.S3_BUCKET_NAME }}",S3Key="${{ steps.upload.outputs.s3_key }}" \
            --region ${{ secrets.AWS_REGION }}

      - name: Deploy to Elastic Beanstalk environment
        run: |
          echo "üöÄ Deploying to environment..."
          aws elasticbeanstalk update-environment \
            --environment-name devshouse-prod \
            --version-label "${{ steps.upload.outputs.version_label }}" \
            --region ${{ secrets.AWS_REGION }}

      - name: Wait for deployment to complete
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          sleep 30
          
          for i in {1..20}; do
            STATUS=$(aws elasticbeanstalk describe-environments \
              --environment-names devshouse-prod \
              --query 'Environments[0].Status' \
              --output text \
              --region ${{ secrets.AWS_REGION }})
            
            echo "Status: $STATUS"
            
            if [ "$STATUS" = "Ready" ]; then
              echo "‚úÖ Deployment completed!"
              break
            fi
            
            if [ $i -eq 20 ]; then
              echo "‚ö†Ô∏è Timeout waiting for deployment"
              exit 1
            fi
            
            sleep 15
          done

      - name: Deployment summary
        run: |
          echo "‚úÖ Backend deployed successfully to Elastic Beanstalk"
          echo "üì¶ Application: devshouse-backend"
          echo "üåç Environment: devshouse-prod"
          echo "üè∑Ô∏è  Version: ${{ steps.upload.outputs.version_label }}"
          echo "üîó URL: http://devshouse-prod.eba-72mpzajd.us-east-1.elasticbeanstalk.com/api"
          
          # Verificar health
          echo ""
          echo "üè• Health Check:"
          HEALTH=$(curl -s http://devshouse-prod.eba-72mpzajd.us-east-1.elasticbeanstalk.com/api/health || echo "Error")
          echo "$HEALTH"
